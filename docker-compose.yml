services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    hostname: zookeeper
    container_name: opensky-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zk-data:/var/lib/zookeeper/data
      - zk-logs:/var/lib/zookeeper/log
    networks:
      - aviation

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    hostname: kafka
    container_name: opensky-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_LOG_RETENTION_HOURS: 168
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - aviation

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: opensky-kafka-ui
    depends_on:
      - kafka
    ports:
      - "8090:8090"
    environment:
      SERVER_PORT: 8090
      KAFKA_CLUSTERS_0_NAME: aviation
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
    networks:
      - aviation

  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    container_name: opensky-clickhouse
    hostname: clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DATABASE:-aviation}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ./configs/clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./configs/clickhouse/access-control.xml:/etc/clickhouse-server/config.d/access-control.xml:ro
      - ./configs/clickhouse/profiles.xml:/etc/clickhouse-server/users.d/profiles.xml:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - aviation
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  grafana:
    image: grafana/grafana:10.2.0
    container_name: opensky-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: 'false'
      GF_INSTALL_PLUGINS: grafana-clickhouse-datasource
      GF_PANELS_ENABLE_ALPHA: 'true'
      # Used by provisioning (configs/grafana/datasources/clickhouse.yml)
      CLICKHOUSE_USER: ${CLICKHOUSE_USER}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
      CLICKHOUSE_HOST: ${CLICKHOUSE_HOST}
      CLICKHOUSE_PORT: ${CLICKHOUSE_PORT}
      CLICKHOUSE_DATABASE: ${CLICKHOUSE_DATABASE}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./configs/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./configs/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./configs/grafana/assets/plane.svg:/usr/share/grafana/public/img/plane.svg:ro
      - ./configs/grafana/assets/plane-ux.svg:/usr/share/grafana/public/img/plane-ux.svg:ro
      - ./configs/grafana/assets/plane-boeing.svg:/usr/share/grafana/public/img/plane-boeing.svg:ro
    depends_on:
      clickhouse:
        condition: service_healthy
    networks:
      - aviation
    restart: unless-stopped

  # OTel Collector Ã© etapa essencial: Kafka -> OTel -> ClickHouse
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.143.0
    container_name: opensky-otel
    depends_on:
      clickhouse:
        condition: service_healthy
      kafka:
        condition: service_started
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./configs/otel/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317"  # OTLP gRPC
      - "4318:4318"  # OTLP HTTP
      - "8888:8888"  # metrics
      - "13133:13133" # health
    environment:
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      KAFKA_TOPIC: ${KAFKA_TOPIC}
      CLICKHOUSE_HOST: ${CLICKHOUSE_HOST}
      CLICKHOUSE_PORT: ${CLICKHOUSE_PORT}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
      CLICKHOUSE_DATABASE: ${CLICKHOUSE_DATABASE}
    networks:
      - aviation
    restart: unless-stopped

  clickhouse-bootstrap:
    image: clickhouse/clickhouse-server:23.8
    container_name: opensky-clickhouse-bootstrap
    depends_on:
      clickhouse:
        condition: service_healthy
      otel-collector:
        condition: service_started
    entrypoint: ["/bin/bash", "/scripts/bootstrap_clickhouse_views.sh"]
    volumes:
      - ./scripts/bootstrap_clickhouse_views.sh:/scripts/bootstrap_clickhouse_views.sh:ro
    environment:
      CLICKHOUSE_HOST: ${CLICKHOUSE_HOST}
      CLICKHOUSE_PORT: ${CLICKHOUSE_PORT}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
      CLICKHOUSE_DATABASE: ${CLICKHOUSE_DATABASE}
    networks:
      - aviation
    restart: "no"

  opensky-producer:
    build:
      context: ./producer
      dockerfile: Dockerfile
    container_name: opensky-producer
    depends_on:
      - kafka
    environment:
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      KAFKA_TOPIC: ${KAFKA_TOPIC}
      KAFKA_COMPRESSION: ${KAFKA_COMPRESSION:-gzip}
      PRODUCER_MODE: ${PRODUCER_MODE:-opensky}
      PUBLISH_RATE_PER_SECOND: ${PUBLISH_RATE_PER_SECOND:-0}
      CAPTURE_ENABLED: ${CAPTURE_ENABLED:-0}
      CAPTURE_DIR: ${CAPTURE_DIR:-/data/opensky_capture}
      REPLAY_DIR: ${REPLAY_DIR:-/data/opensky_capture}
      REPLAY_MESSAGES_PER_SECOND: ${REPLAY_MESSAGES_PER_SECOND:-200}
      REPLAY_LOOP: ${REPLAY_LOOP:-1}
      DISABLE_DEDUP: ${DISABLE_DEDUP:-0}
      OPENSKY_USERNAME: ${OPENSKY_USERNAME}
      OPENSKY_PASSWORD: ${OPENSKY_PASSWORD}
      OPENSKY_CLIENT_ID: ${OPENSKY_CLIENT_ID:-}
      OPENSKY_CLIENT_SECRET: ${OPENSKY_CLIENT_SECRET:-}
      OPENSKY_TOKEN_URL: ${OPENSKY_TOKEN_URL:-https://auth.opensky-network.org/auth/realms/opensky-network/protocol/openid-connect/token}
      POLL_INTERVAL_SECONDS: ${POLL_INTERVAL_SECONDS}
      REQUEST_TIMEOUT_SECONDS: ${REQUEST_TIMEOUT_SECONDS}
      BBOX_MIN_LAT: ${BBOX_MIN_LAT:-}
      BBOX_MAX_LAT: ${BBOX_MAX_LAT:-}
      BBOX_MIN_LON: ${BBOX_MIN_LON:-}
      BBOX_MAX_LON: ${BBOX_MAX_LON:-}
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: http://otel-collector:4318/v1/traces
      OTEL_SERVICE_NAME: opensky-producer
    networks:
      - aviation
    volumes:
      - producer-data:/data
    restart: unless-stopped

networks:
  aviation:
    driver: bridge

volumes:
  zk-data:
  zk-logs:
  kafka-data:
  clickhouse-data:
  grafana-data:
  producer-data:
